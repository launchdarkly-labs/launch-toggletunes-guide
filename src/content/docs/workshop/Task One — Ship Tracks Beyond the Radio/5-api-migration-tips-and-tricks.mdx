---
sidebar_position: 6
title: Enhancing Our API Migration
---

## Handling API Migrations Like a Pro

As we saw with introducing our new webstore, release targeting can be a very powerful tool for testing in production. It's a foundational part of modern software development with LaunchDarkly, and we can apply the same targeting concepts we used earlier to roll out a migration to any user. 

We've shown how we can release features quickly, and recover with the flip of a toggle... but how can we let the sysytem recover itself in the event of a problem?

## Step 1: Immediate resolution with flag triggers

Unfortunately, issues with technology migrations don't always play nice with work schedules. Usually they wait until the wee hours of the morning or the weekend to have a hiccup and the unfortunate SRE on call has to scramble to take care of the fallout. Does it have to be? As you might have suspected, the answer is, "No, you don't need to wake someone up at 2:00am on a Saturday to take care of a broken API!" ðŸ˜…

### Go to flag settings
Go to the `billing` flag and select the `Settings` tab. Here you will see an option to `+ Add trigger` and choose the Generic Trigger. It will look something like this:

![](@assets/img/flag-trigger.png)

### Creating a flag trigger  
Create a `Generic trigger`, copy the new Flag Trigger URL that was created and save it in a note, we will need that in a moment.


:::tip[All the Flag Triggers]
<details>
<summary>What other flag triggers can I create?</summary>
<p>
Flag Triggers can be integrated into popular APM solutions like <strong>Datadog</strong>, <strong>Honeycomb</strong>, <strong>SignalFX</strong>, <strong>New Relic</strong>, and more! When using these integration, custom events sent from the APM can trigger the changing of a flag.
</p>
</details>
:::

### Add flag trigger to your code
Copy the code block below, and use it to replace the existing code in the `/src/hooks/useErrorHandling.ts` file. We'll be replacing ALL the code with this new code, so make sure you copy the entire block.

```tsx
// hooks/useErrorHandling.ts
import { useState } from 'react';
import { useShoppingCart } from 'use-shopping-cart';

const useErrorHandling = () => {
  const triggerURL = 'PASTE_TRIGGER_URL_HERE';
  const [errorState, setErrorState] = useState(false);

  const { clearCart } = useShoppingCart();

  const Trigger = async () => {
    try {
      const response = await fetch(
        triggerURL,
        {
          method: "POST",
          body: JSON.stringify({
            eventName: "There was an error with the API",
          }),
        }
      );
      return response.status;
    } catch (error) {
      console.log("the fetch did not work");
    }
  };

  const errorTesting = async () => {
    try {
      const response = await fetch("/api/checkout", {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      });
      const jsonData = await response.json();
      if (jsonData == "the API is unreachable") {
        setErrorState(true);
         clearCart()
         Trigger()
        return 502;
      } else {
        setErrorState(false);
      }
    } catch (e) {
      console.log("is it running?");
      console.log(e)
    }
  };

  return { errorState, setErrorState, errorTesting };
};

export default useErrorHandling;
```

### Update the code with your trigger URL
On line 6, replace the text `PASTE_TRIGGER_URL_HERE` with your Flag Trigger URL

### Test the trigger 
Turn off the `enableStripe` flag and then try adding something to the cart. You'll see the error message pop up, but this time when you close it, it will have automatically reverted to the self-hosted form and your flag will be disabled in LaunchDarkly.

While flag triggers are good in case something goes wrong, if we know that two flags are reliant on one another, like these two flags are. We have another way of ensuring that one can't be turned on without the other.

:::caution[Important Notes]  
_If you implement this code without a flag trigger URL, the application will crash. Adding a flag trigger is not a necessary step to continuing through this workshop, so if you are having trouble, skip this step!_   

**Turn Your Flags Back On!**  
_If you ran through the flag trigger demo, make sure you turn both flags back on before proceeding, otherwise, it's going to cause things to break!_ 
:::


## Step 2: Introducing prerequisite flags

Before we get started, let's recap what exactly happened with our failed migration earlier. We have two components:

1. `billing` flag: controls the frontend UI components
2. `enableStripe` flag: controls the API connection with Stripe

The frontend changes (made available by the `billing` flag) don't work properly if the backend capabilities aren't enabled (the `enableStripe` flag). In order to prevent this misconfiguration from creating errors for customers in the future we are going to create a **Prerequisite Flag**.

### Adding a prequisite
Navigate back to your LaunchDarkly dashboard and open the settings for the `billing` flag. At the top of the page, you'll see an option to Add prerequisite:

![](/img/prereq.png)

### Create the rule
Create a prequisite rule that says the `enableStripe` flag must be serving `Stripe Checkout Enabled`.


:::tip[Tying Flags Together]
<details>
<summary>Why do we need a prerequisite flag?</summary>
<p>
These two components are reliant on one another in order to operate correctly, but they're managed by two different teams: Web developers and API team. While we like to think that communication is never an issue, miscommunications happen and teams forget to inform one another when they are pushing changes or doing maintenance.
</p>
</details>
:::

Save and review the changes and you'll see that the cart functionality still works. Try switching off the `enableStripe` flag and check your application, you'll notice we're back to the self hosted form! 

Using this, it means we only have to turn off the `enableStripe` flag if there's an issue or maintenance is being done and it will disable the frontend features automatically!


:::caution[Having Issues?]
<details>
<summary>Click here for some troubleshooting tips</summary>
<p>
If you're having trouble with any of these steps:
</p>
<ul>
<li>If you are unable to get the flag trigger to work, make sure you have the correct URL in your code.</li>
<li>Make sure you replace lines 9-40 with the new flag trigger code.</li>
<li>If it seems like your prerequisite flag isn't working, double check the default variation in your flag.</li>
</ul>
</details>
:::