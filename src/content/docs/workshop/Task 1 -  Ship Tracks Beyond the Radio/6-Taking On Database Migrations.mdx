---
sidebar_position: 7
title: Migrating to Our New Database
---

import styles from "@styles/index.module.css";
import { Copy, CheckSquare } from "lucide-react";
import CopyField from "../../../../components/copyfield.tsx";

export const completeModule = async () => {
  const response = await fetch("/api/service-1", {
    method: "GET",
    mode: "cors",
  });
  window.location.assign("/docs/Target%20And%20Personalize/mission-brief");
};

Data is at the heart of every application and Toggle Outfitter's website is no exception. The Toggle Outfitters team had a complex manual process for updating their store inventory including spreadsheets and a local file to drive inventory updates. It's slow, and on more than one occasion its been totally forgotten about. As the the platform is taking on more traffic, the team is looking to move to a more centralized database that can respond to scale demands and simplify their operations.

## Step 1: Creating Our New Inventory View

To enhance this further, we want to allow store administrators to be able to view the inventory data from within the application, as well as view the current status of the database at an operational level. To do this, we'll need to make some changes to our application.

### Create a new feature flag
Here are our configurations for the flag that we'll need, you can create this as a release flag:
<div className="flex flex-col space-y-1 text-black dark:text-white">
    <div className="text-lg font-bold text-blue-500">Flag Name: <span className="text-black dark:text-white font-normal">Admin View</span></div>
    <div className="flex items-center space-x-3">
        <span className="text-lg text-blue-500 font-bold">Flag Key:</span>
        <CopyField value='adminMode' client:load />
    </div>
    <p className="text-lg font-bold text-blue-500">Description: <span className="text-black dark:text-white font-normal">optional, if you would like to add</span></p>
    <p className="text-lg font-bold text-blue-500">Flag Variations:</p>
    <p className="text-lg text-black dark:text-white">Boolean</p>
        <p className="text-lg text-black dark:text-white">Variations:</p>
        <div className="flex items-center space-x-3">
    <span className="text-lg ml-8 text-black dark:text-white">true:</span> 
    <CopyField value='Admin Mode Enabled' client:load />
    </div>
      <div className="flex items-center space-x-3">
        <span className="text-lg text-black dark:text-white ml-8">false:</span> 
        <CopyField value='Admin Mode Disabled' client:load />
        </div>
                <p className="text-lg font-bold text-blue-500">Advanced Configurations:</p>
        <div className="flex items-center space-x-3">
    <span className="text-lg ml-8 text-black dark:text-white"> Check Box for SDKs using Client-side ID</span> 
    </div>
</div>

### Update the code

Locate the `/src/components/menu.tsx` file and add this code in the specified location within the file (lines 67-70):

```jsx title='/src/components/menu.tsx'
{
  adminMode ? (
    <NavigationMenu.Item>
      <NavigationMenuLink>
        <AdminPanel />
      </NavigationMenuLink>
    </NavigationMenu.Item>
  ) : null
}
```

This will give our admins the ability to see inventory and order details in its own separate component.

### Release Targeting - Optional

Open up the new `adminMode` flag that you just created. Under quick start, click on the "Build my own rule" option.

Select `name` and `is one of` then move to the Values box. Instead of typing something, just click into the box and give it a second to load...

![](@assets/img/loaded-values.png)

Would you look at that?! You should see the username that you were previously using when logging in as part of the `Developer` segment! Choose your name, and set the rollout to "Admin mode enabled". Finally, save the changes to your flag.

:::tip[Understanding The Context]
<details>
<summary>Wait, what just happened?</summary>
<p>
Up to this point we've been using the <code>Developers</code> segment as our catch-all for when we don't want to fully release the feature, but we can get even more targeted than that! We can use the <code>users</code> context kind to target specific users. This is a great way to test out new features with a small group of users before rolling it out to everyone - especially when you want to target yourself for testing purposes!

LaunchDarkly keeps track of this information for you and pre-populates it as an option when creating rules. Again, we'll dive more into release targeting and contexts in the next section, but for now just choose your username, set the default rule to <code>false</code>, turn on the flag, and save.

</p>
</details>
:::

:::tip[Are "Kinds" always "Users"?]
<details>
  <summary>Do I always have to use the user kind</summary>
  <p>
    No! Context kinds can be any sort of identifying information that you
    collection from an application. In this case we're mainly using `users`, but
    we could easily use things like <code>region</code>, <code>store</code>,{" "}
    <code>device</code>, <code>organization</code>, or anything else!
  </p>
</details>
:::

## Step 2: Flagging Our Backend - Database Preparation

In addition to having our administrative view, we need to set up our application to interact with the new database. To do this we'll need to update another one of our API files.

### Create The Database Feature Flag

To complete our migration safely and fast, we're going to create another release type feature flag:

<div className="flex flex-col space-y-1 text-black dark:text-white">
    <div className="text-lg font-bold text-blue-500">Flag Name: <span className="text-black dark:text-white font-normal">Enable New Centralized Database</span></div>
    <div className="flex items-center space-x-3">
        <span className="text-lg text-blue-500 font-bold">Flag Key:</span>
        <CopyField value='dbTesting' client:load />
    </div>
    <p className="text-lg font-bold text-blue-500">Description: <span className="text-black dark:text-white font-normal">optional, if you would like to add</span></p>
    <p className="text-lg font-bold text-blue-500">Flag Variations:</p>
    <p className="text-lg text-black dark:text-white">String</p>
        <p className="text-lg text-black dark:text-white">Variations:</p>
        <div className="flex items-center space-x-3">
    <span className="text-lg ml-8 text-black dark:text-white">Variation 1:</span> 
    <CopyField value='postgres' client:load />
    </div>
      <div className="flex items-center space-x-3">
        <span className="text-lg text-black dark:text-white ml-8">Variation 2:</span> 
        <CopyField value='static' client:load />
        </div>
                <p className="text-lg font-bold text-blue-500">Advanced Configurations:</p>
        <div className="flex items-center space-x-3">
    <span className="text-lg ml-8 text-black dark:text-white"> Check Box for SDKs using Client-side ID</span> 
    </div>
</div>

### Update Our Database API

Locate the `/src/pages/api/inventory.ts` file and copy and paste this code in the correct place (line 47):

```jsx title='/src/pages/api/inventory.ts'
//we are again evaluating the value of the flag before running a function.
// In this case if the dbTesting flag returns 'postgres' we are running a function to connect to our new database.
dbTesting = await ldClient.variation("dbTesting", jsonObject, false);

if (dbTesting == "postgres") {
  databaseConnection(req, res);
} else {
  res.status(200).json(product);
}
```
:::tip[What's happening in this evaluation?]
<details>
  <summary>What's going on in this file?</summary>
  <p>
    This code retrieves data from our hosted Postgres table and returns it back
    for view in the Admin Mode screen. Note, you can observe the Database
    configurations within the `prisma/schema.prisma` file, which contains all
    the database models. You can also view the database connection code in the
    `/utils/databaseConnection.ts` file, which is the helper file for handling
    the database connection.
  </p>
</details>
:::

### Review the Status

Open the Admin View in your application. It should look like this:

![](@assets/img/admin-view.png)

### Complete the Migration

Enable the `dbTesting` flag to serve `postgres`.

You should see the table update! This is data being pulled from that centralized Postgres table instead of a local file. Pretty cool huh? We moved data sources without having to redeploy anything or jump through a bunch of networking hoops, just turning a flag on!

However, before turning the flag on. There's another scenario that we should explore, that being Flag Approvals.

## Step 3: Leveraging Flag Approvals

In your newly created `dbTesting` flag, change targeting to on, but instead of hitting Review & Save, hit the dropdown menu:

![](@assets/img/approval.png)

Notice the option for `Request approval`. This is where we can ensure that the right members of our team are aware that we are planning to migrate to the new database. Select that option brings up a screen like this:

![](@assets/img/approval-screen.png)

Here we can provide the reason for why we are looking to enable this flag and select the necessary reviewers. We could add our Database Admin to the list of approvers so if there's a problem or they aren't ready for the migration, they can either reject the request or hold off until they know the system is ready. No miscommunication, no outages, no worries! ðŸ˜€

:::tip[When would I use approvals?]
<details>
  <summary>Asking forgiveness vs permission</summary>
  <p>
    Normally, organizations have different people responsible for different
    tools, for example dedicated Database Admins who are responsible for the
    maintenance and management of the databases. These users are yet another
    team that we're interacting with and are ultimately responsible for the data
    being both available and healthy. Because of this, we probably should
    involve them when we are planning to send live traffic to the database. With
    LaunchDarkly, we can give them control over when a new database becomes
    accessible.
  </p>
</details>
:::

Since we're using LaunchDarkly and release and migrations are risk free, the Database Admin team is taking an offsite in Bora Bora. They aren't around to approve our requests - so we'll move forward! 

:::caution[Having issues?]
<details>
  <summary>Click here for some troubleshooting tips</summary>
  <p>If you're having trouble with any of these steps:</p>
  <ul>
    <li>
      If you aren't seeing the new database information, make sure you chose a{" "}
      <code>string</code> flag instead of a <code>boolean</code>.{" "}
    </li>
    <li>
      {" "}
      If you do not see the Admin Panel, check that you are logged in and that your
      flag is evaluating correctly
    </li>
  </ul>
</details>
:::

{/* <div
  style={{
    paddingBottom: "20px",
    paddingTop: "20px",
    justifyContent: "center",
    display: "flex",
    alignItems: "center",
  }}
>
  <button id="Button" className={styles.buttons2} onClick={completeModule}>
    Complete Module
  </button>
</div> */}
